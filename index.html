<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Body Composition Dashboard</title>
<meta name="theme-color" content="#0b0f17" />
<style>
  :root{
    --bg:#0b0f17; --panel:#0f1624; --panel2:#121c2e; --text:#e8edf6; --muted:#9aa7bd;
    --line:#1f2a40; --good:#2ad37d; --warn:#ffcc66; --bad:#ff5b5b; --accent:#4aa3ff;
    --shadow: 0 12px 30px rgba(0,0,0,.35);
    --r:16px;
    font-synthesis-weight:none;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:radial-gradient(1200px 700px at 20% 0%, rgba(74,163,255,.12), transparent 60%), var(--bg);color:var(--text);}
  a{color:inherit}
  .wrap{max-width:1160px;margin:0 auto;padding:18px 16px 40px;}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg, rgba(74,163,255,.9), rgba(42,211,125,.8));box-shadow:var(--shadow)}
  h1{font-size:18px;margin:0}
  .sub{font-size:12px;color:var(--muted);margin-top:2px}
  .row{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
  @media (max-width: 980px){.row{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);}
  .card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px;border-bottom:1px solid var(--line)}
  .card .hd .t{font-weight:700;font-size:13px}
  .card .bd{padding:14px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width: 980px){.grid{grid-template-columns:repeat(2,1fr);}}
  .kpi{padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.22)}
  .kpi .k{font-size:11px;color:var(--muted)}
  .kpi .v{font-size:18px;font-weight:800;margin-top:4px}
  .kpi .s{font-size:11px;color:var(--muted);margin-top:2px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
.modebar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 8px}
  .modebtn{padding:8px 12px;border-radius:999px;font-size:12px}
  .modebtn.active{background:linear-gradient(135deg, rgba(74,163,255,.95), rgba(74,163,255,.55));border-color:transparent;color:#07131f;font-weight:700}
  button{appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  button:hover{border-color:rgba(74,163,255,.55)}
  .primary{background:linear-gradient(135deg, rgba(74,163,255,.95), rgba(74,163,255,.55));border-color:transparent}
  .danger{background:linear-gradient(135deg, rgba(255,91,91,.95), rgba(255,91,91,.55));border-color:transparent}
  .muted{color:var(--muted)}
  .calendar{display:grid;grid-template-columns:repeat(7, 1fr);gap:8px}
  .dow{font-size:11px;color:var(--muted);text-align:center}
  .day{min-height:86px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.20);padding:10px;cursor:pointer;position:relative}
  .day:hover{border-color:rgba(74,163,255,.55)}
  .day .d{font-size:12px;font-weight:800}
  .day .meta{font-size:11px;color:var(--muted);margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:10px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
  .b-good{border-color:rgba(42,211,125,.5);color:#c8ffe5}
  .b-warn{border-color:rgba(255,204,102,.55);color:#ffe8b8}
  .b-bad{border-color:rgba(255,91,91,.55);color:#ffd1d1}
  .b-accent{border-color:rgba(74,163,255,.55);color:#d7ecff}
  .dot{position:absolute;top:10px;right:10px;width:8px;height:8px;border-radius:50%}
  .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  .table{width:100%;border-collapse:collapse;font-size:12px}
  .table th,.table td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:700;font-size:11px}
  .table tr:hover td{background:rgba(255,255,255,.02)}
  .right{text-align:right}
  .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field{display:flex;flex-direction:column;gap:6px;min-width:160px;flex:1}
  label{font-size:11px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--text);outline:none}
  textarea{min-height:84px;resize:vertical}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:680px){.two{grid-template-columns:1fr;}}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px}
  .modal.open{display:flex}
  .modal .panel{width:min(920px, 100%);max-height:85vh;overflow:auto;background:linear-gradient(180deg, rgba(15,22,36,.98), rgba(10,14,23,.98));border:1px solid var(--line);border-radius:18px;box-shadow: 0 25px 70px rgba(0,0,0,.55)}
  .modal .ph{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--line)}
  .modal .pb{padding:14px}
  .x{width:38px;height:38px;border-radius:12px}
  .small{font-size:11px;color:var(--muted)}
  canvas{width:100%;height:180px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:rgba(15,22,36,.95);border:1px solid var(--line);padding:10px 12px;border-radius:14px;display:none;box-shadow:var(--shadow);font-size:12px}
  .toast.show{display:block}

  .ghost{background:transparent;border:1px solid rgba(0,0,0,.12);} 
</style>

<script>
/* Locked Google credentials (same as Expense Tracker) */
const GOOGLE_CLIENT_ID = "41189729388-rksho3qtsot9qv7h2g4c0s8q81ghub6u.apps.googleusercontent.com";
const GOOGLE_API_KEY = "AIzaSyD3SRe0koUE0MdEE0JWllD5V8L1koP7iGs";
</script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Body Composition Dashboard</h1>
        <div class="sub">Single-file tracker • Local-first (localStorage) • Calendar + KPI + easy import/export</div>
      </div>
    </div>
    
    <div class="modebar" role="group" aria-label="Program mode">
      <button class="modebtn" data-mode="fatloss">Fat loss</button>
      <button class="modebtn" data-mode="weightloss">Weight loss</button>
      <button class="modebtn" data-mode="weightgain">Weight gain</button>
    </div>
<div class="btns">
      <button id="btnToday">Jump to Today</button>
      <button id="btnSettings">Targets / Rules</button>
      <button id="btnDrive" class="ghost">☁ Drive: Off</button>
      <button id="btnExport" class="primary">Export (JSON)</button>
      <button id="btnImport">Import (JSON)</button>
      <button id="btnReset" class="danger">Reset</button>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div class="hd">
        <div class="t">This Month</div>
        <div class="pill" id="monthPill">—</div>
      </div>
      <div class="bd">
        <div class="calendar" id="calHead"></div>
        <div style="height:8px"></div>
        <div class="calendar" id="calendar"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="t">Dashboard</div>
        <div class="pill" id="phasePill">Phase: Cut</div>
      </div>
      <div class="bd">
        <div class="grid">
          <div class="kpi">
            <div class="k">Avg calories (7d)</div>
            <div class="v" id="kAvgCal">—</div>
            <div class="s" id="kAvgCalS">Target: —</div>
          </div>
          <div class="kpi">
            <div class="k">Avg protein (7d)</div>
            <div class="v" id="kAvgP">—</div>
            <div class="s" id="kAvgPS">Target: —</div>
          </div>
          <div class="kpi">
            <div class="k">Scale trend (7d)</div>
            <div class="v" id="kWt">—</div>
            <div class="s" id="kWtS">Goal: steady down</div>
          </div>
          <div class="kpi">
            <div class="k">Refeed flag</div>
            <div class="v" id="kRefeed">—</div>
            <div class="s" id="kRefeedS">Auto-suggested</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="two">
          <div>
            <div class="small">Weight trend</div>
            <canvas id="wtChart" width="800" height="240"></canvas>
          </div>
          <div>
            <div class="small">Calories vs Target</div>
            <canvas id="calChart" width="800" height="240"></canvas>
          </div>
        </div>
        
        <div class="chartgrid">
          <div>
            <div class="small">Macros (today)</div>
            <canvas id="macroPie" width="400" height="240"></canvas>
          </div>
          <div>
            <div class="small">Adherence (7d)</div>
            <canvas id="adhPie" width="400" height="240"></canvas>
          </div>
        </div>
        <div style="height:10px"></div>
<div style="height:10px"></div>
        <div class="small">Tip: only the <b>Total Burn</b> field is needed to compute deficit. If you can’t see WHOOP calories, just enter your best estimate (or leave blank).</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="hd">
      <div class="t">Recent days</div>
      <div class="pill">Click a day in calendar to edit</div>
    </div>
    <div class="bd" style="overflow:auto">
      <table class="table" id="recentTable">
        <thead>
          <tr>
            <th>Date</th><th>Training</th><th>Recovery</th><th class="right">Target</th><th class="right">Eaten</th><th class="right">Total Burn</th><th class="right">Deficit</th><th class="right">Protein</th><th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Day modal -->
<div class="modal" id="dayModal" role="dialog" aria-modal="true">
  <div class="panel">
    <div class="ph">
      <div>
        <div style="font-weight:800" id="mTitle">—</div>
        <div class="small" id="mSub">—</div>
      </div>
      <div class="btns">
        <button id="btnAutofill">Autofill targets</button>
        <button id="btnSave" class="primary">Save</button>
        <button id="btnClose" class="x">✕</button>
      </div>
    </div>
    <div class="pb">
      <div class="two">
        <div class="field">
          <label>Date</label>
          <input id="fDate" type="date" />
        </div>
        <div class="field">
          <label>Day</label>
          <input id="fDay" placeholder="Mon, Tue..." />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Training Type (comma separated)</label>
          <input id="fTrain" placeholder="Gym,Padel" />
        </div>
        <div class="field">
          <label>WHOOP Strain (optional)</label>
          <input id="fStrain" type="number" step="0.1" placeholder="e.g. 10.4" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Recovery</label>
          <select id="fRecovery">
            <option value="">—</option>
            <option value="Green">Green</option>
            <option value="Yellow">Yellow</option>
            <option value="Red">Red</option>
          </select>
        </div>
        <div class="field">
          <label>Phase</label>
          <select id="fPhase">
            <option>Cut</option>
            <option>Maintenance</option>
          </select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Calories Target</label>
          <input id="fTarget" type="number" step="1" />
        </div>
        <div class="field">
          <label>Calories Eaten</label>
          <input id="fEaten" type="number" step="1" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Total Burn (TDEE from WHOOP / estimate)</label>
          <input id="fBurn" type="number" step="1" placeholder="e.g. 3200" />
        </div>
        <div class="field">
          <label>Re-feed day?</label>
          <select id="fRefeed">
            <option value="">No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Protein (g)</label>
          <input id="fP" type="number" step="1" />
        </div>
        <div class="field">
          <label>Carbs (g)</label>
          <input id="fC" type="number" step="1" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Fat (g)</label>
          <input id="fF" type="number" step="1" />
        </div>
        <div class="field">
          <label>Weight (kg)</label>
          <input id="fW" type="number" step="0.1" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Waist (cm)</label>
          <input id="fWaist" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea id="fNotes" placeholder="Quick notes: sleep, hunger, steps, etc."></textarea>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="pill" id="mDeficitPill">Deficit: —</div>
      <div class="small" id="mHint" style="margin-top:8px">Rule: deficit is <b>Total Burn − Calories Eaten</b>. Your workout calories (e.g., 364) are only a part of Total Burn.</div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="settingsModal" role="dialog" aria-modal="true">
  <div class="panel">
    <div class="ph">
      <div>
        <div style="font-weight:800">Targets & Rules (hard-lock)</div>
        <div class="small">Edit once, then just follow. Stored locally.</div>
      </div>
      <div class="btns">
        <button id="btnSaveSettings" class="primary">Save</button>
        <button id="btnCloseSettings" class="x">✕</button>
      </div>
    </div>
    <div class="pb">
      <div class="two">
        <div class="field">
          <label>Program mode (preset)</label>
          <select id="sMode">
            <option value="fatloss">Fat loss (11–14% target)</option>
            <option value="weightloss">Weight loss (general)</option>
            <option value="weightgain">Weight gain (lean bulk)</option>
          </select>
        </div>
        <div class="field">
          <label>Apply preset</label>
          <button id="btnApplyMode" class="primary" style="width:100%">Apply</button>
        </div>
      </div>
      <div style="height:10px"></div>

      <div class="two">
        <div class="field">
          <label>Rest day calories</label>
          <input id="sRest" type="number" />
        </div>
        <div class="field">
          <label>Gym day calories</label>
          <input id="sGym" type="number" />
        </div>
      </div>
      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Padel / Football day calories</label>
          <input id="sSport" type="number" />
        </div>
        <div class="field">
          <label>Refeed calories (carb-up)</label>
          <input id="sRefeed" type="number" />
        </div>
      </div>
      <div class="two" style="margin-top:10px">
        <div class="field">
          <label>Protein target (g/day)</label>
          <input id="sProt" type="number" />
        </div>
        <div class="field">
          <label>Fat target (g/day)</label>
          <input id="sFat" type="number" />
        </div>
      </div>
      <div class="field" style="margin-top:10px">
        <label>Auto refeed trigger (simple)</label>
        <select id="sRefeedRule">
          <option value="recovery2red">2 days in a row Red recovery</option>
          <option value="recovery3yellow">3 days in a row Yellow/Red recovery</option>
          <option value="strainHighLowCal">Strain ≥ 15 AND calories &lt; target by 400+</option>
          <option value="off">Off</option>
        </select>
      </div>

      <div style="height:10px"></div>
      <div class="card" style="box-shadow:none">
        <div class="hd"><div class="t">Screenshot rule card (no-thinking)</div></div>
        <div class="bd">
          <div class="small" id="ruleCardText"></div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="small muted">
        Notes:
        <ul>
          <li>Your deficit is based on <b>TDEE / Total Burn</b>, not “workout calories”.</li>
          <li>If you can’t find WHOOP calories, just enter a reasonable daily Total Burn estimate (ex: 3000–3400) and adjust weekly based on scale trend.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ---------- Seed (February 2026 sample) ----------
  const SEEDED_ROWS = [{"Day": "Sun", "Date": "2026-02-01", "Training Type": "Rest", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Mon", "Date": "2026-02-02", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Tue", "Date": "2026-02-03", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Wed", "Date": "2026-02-04", "Training Type": "Gym,Football", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Thu", "Date": "2026-02-05", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Fri", "Date": "2026-02-06", "Training Type": "Gym,Padel", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Sat", "Date": "2026-02-07", "Training Type": "Football,Walk,Swim", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "Weekly check-in", "Notes": ""}, {"Day": "Sun", "Date": "2026-02-08", "Training Type": "Rest", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Mon", "Date": "2026-02-09", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Tue", "Date": "2026-02-10", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Wed", "Date": "2026-02-11", "Training Type": "Gym,Football", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Thu", "Date": "2026-02-12", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Fri", "Date": "2026-02-13", "Training Type": "Gym,Padel", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Sat", "Date": "2026-02-14", "Training Type": "Football,Walk,Swim", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "Re-feed optional", "Notes": ""}, {"Day": "Sun", "Date": "2026-02-15", "Training Type": "Rest", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Mon", "Date": "2026-02-16", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Tue", "Date": "2026-02-17", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Wed", "Date": "2026-02-18", "Training Type": "Gym,Football", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Thu", "Date": "2026-02-19", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Fri", "Date": "2026-02-20", "Training Type": "Gym,Padel", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Sat", "Date": "2026-02-21", "Training Type": "Football,Walk,Swim", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "Weekly check-in", "Notes": ""}, {"Day": "Sun", "Date": "2026-02-22", "Training Type": "Rest", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Mon", "Date": "2026-02-23", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Tue", "Date": "2026-02-24", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Wed", "Date": "2026-02-25", "Training Type": "Gym,Football", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Thu", "Date": "2026-02-26", "Training Type": "Gym", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Fri", "Date": "2026-02-27", "Training Type": "Gym,Padel", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Green", "Recovery": "", "Re-feed Day": "Cut", "Phase": "", "Notes": ""}, {"Day": "Sat", "Date": "2026-02-28", "Training Type": "Football,Walk,Swim", "WHOOP Strain": null, "Calories Eaten": null, "Protein (g)": null, "Carbs (g)": null, "Fat (g)": null, "Weight (kg)": null, "Waist (cm)": "Yellow", "Recovery": "", "Re-feed Day": "Cut", "Phase": "End of month review", "Notes": ""}];

  // ---------- Storage ----------
  const LS_KEY = "fatloss_log_v1";
  const LS_SETTINGS = "fatloss_settings_v1";

  const DEFAULT_SETTINGS = {
    mode: "fatloss",
    phase: "Cut",
    cals_rest: 2300,
    cals_gym: 2500,
    cals_sport: 2700,
    cals_refeed: 2900,
    protein_g: 200,
    fat_g: 70,
    refeed_rule: "recovery3yellow"
  };

  const MODE_PRESETS = {
    fatloss:   { label:"Fat loss (11–14%)", phase:"Cut",     cals_rest:2300, cals_gym:2500, cals_sport:2700, cals_refeed:2900, protein_g:200, fat_g:70 },
    weightloss:{ label:"Weight loss",       phase:"Cut",     cals_rest:2500, cals_gym:2700, cals_sport:2900, cals_refeed:3100, protein_g:190, fat_g:80 },
    weightgain:{ label:"Weight gain",       phase:"Bulk",    cals_rest:3200, cals_gym:3500, cals_sport:3700, cals_refeed:3900, protein_g:190, fat_g:90 }
  };


  function loadSettings() {
    try {
      const s = JSON.parse(localStorage.getItem(LS_SETTINGS) || "null");
      return {...DEFAULT_SETTINGS, ...(s||{})};
    } catch(e) {
      return {...DEFAULT_SETTINGS};
    }
  }

  function saveSettings(s) {
    localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
  }

  function loadData() {
    // Always return an array. Older versions may have stored objects.
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) return parsed;
      if (parsed && Array.isArray(parsed.data)) return parsed.data;
      if (parsed && Array.isArray(parsed.rows)) return parsed.rows;
      return [];
    } catch(e) {
      return [];
    }
  }

      }
      uiDriveStatus("On ✓");
    }catch(e){
      console.error(e);
      uiDriveStatus("On (error)");
      toast("Drive pull failed");
    }finally{
      DRIVE.isBusy = false;
      setTimeout(()=> uiDriveStatus(DRIVE.enabled ? "On" : "Off"), 1800);
    }
  }

  function driveEnqueueAutoSync(){
    if(!DRIVE.enabled || !DRIVE.autoSync) return;
    clearTimeout(DRIVE.syncTimer);
    DRIVE.syncTimer = setTimeout(()=>{ drivePushNow(); }, 2500);
  }

function saveData(rows) {
    localStorage.setItem(LS_KEY, JSON.stringify(rows));
  }

  function iso(d) {
    const z = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }

  function dayName(d) {
    return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
  }

  // ---------- Data model ----------
  // Row shape:
  // { Date, Day, "Training Type", "WHOOP Strain", "Calories target", "Calories Eaten", "Protein (g)", "Carbs (g)", "Fat (g)", "Weight (kg)", "Waist (cm)", Recovery, "Re-feed Day", Phase, Notes, "Total Burn" }
  function normalizeRow(r) {
    const rr = {...r};
    rr["Training Type"] = (rr["Training Type"]||"").replace(/;/g,",").replace(/\s+/g,"").replace(/,+/g,",").replace(/^,|,$/g,"");
    rr["Re-feed Day"] = rr["Re-feed Day"] || "";
    rr["Phase"] = rr["Phase"] || "Cut";
    rr["Notes"] = rr["Notes"] || "";
    rr["Total Burn"] = (rr["Total Burn"] ?? "");
    return rr;
  }

  function getOrCreateMonth(baseDate) {
    const start = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
    const end = new Date(baseDate.getFullYear(), baseDate.getMonth()+1, 0);
    const rows = [];
    for (let d = 1; d <= end.getDate(); d++) {
      const dt = new Date(baseDate.getFullYear(), baseDate.getMonth(), d);
      rows.push(normalizeRow({
        "Date": iso(dt),
        "Day": dayName(dt),
        "Training Type": "",
        "WHOOP Strain": "",
        "Calories target": "",
        "Calories Eaten": "",
        "Protein (g)": "",
        "Carbs (g)": "",
        "Fat (g)": "",
        "Weight (kg)": "",
        "Waist (cm)": "",
        "Recovery": "",
        "Re-feed Day": "",
        "Phase": "Cut",
        "Notes": "",
        "Total Burn": ""
      }));
    }
    return rows;
  }

  // Merge seeded rows into current month rows by Date
  function mergeByDate(rows, seeded) {
    const m = new Map(rows.map(r => [r.Date, r]));
    for (const s of seeded) {
      const sd = s.Date;
      if (!sd) continue;
      const tgt = m.get(sd);
      if (tgt) {
        // only copy non-empty seeded fields
        for (const k of Object.keys(s)) {
          if (s[k] !== "" && s[k] != null) tgt[k] = s[k];
        }
      }
    }
    return Array.from(m.values()).sort((a,b)=>a.Date.localeCompare(b.Date));
  }

  // ---------- Targets ----------
  function inferTargetCalories(row, settings) {
    if ((row["Re-feed Day"]||"") === "Yes") return settings.cals_refeed;
    const t = (row["Training Type"]||"").toLowerCase();
    if (!t) return settings.cals_rest;
    const hasGym = t.includes("gym");
    const hasPadel = t.includes("padel");
    const hasFootball = t.includes("football");
    if (hasPadel || hasFootball) return settings.cals_sport;
    if (hasGym) return settings.cals_gym;
    return settings.cals_rest;
  }

  function inferMacros(row, settings) {
    const target = Number(row["Calories target"]||inferTargetCalories(row, settings)) || inferTargetCalories(row, settings);
    const p = settings.protein_g;
    const f = settings.fat_g;
    const calPF = p*4 + f*9;
    const carbs = Math.max(0, Math.round((target - calPF)/4));
    return {p, f, c: carbs, target};
  }

  function deficit(row) {
    const burn = Number(row["Total Burn"] || "");
    const eaten = Number(row["Calories Eaten"] || "");
    if (!burn || !eaten) return null;
    return burn - eaten;
  }

  function recoveryClass(r) {
    const v = (r||"").toLowerCase();
    if (v==="green") return "good";
    if (v==="yellow") return "warn";
    if (v==="red") return "bad";
    return "";
  }

  // ---------- UI ----------
  const $ = (id)=>document.getElementById(id);
  const calHead = $("calHead");
  const cal = $("calendar");
  const recentBody = $("recentTable").querySelector("tbody");
  const toast = $("toast");

  // modals
  const dayModal = $("dayModal");
  const settingsModal = $("settingsModal");

  const fields = {
    date:$("fDate"), day:$("fDay"), train:$("fTrain"), strain:$("fStrain"), recovery:$("fRecovery"),
    phase:$("fPhase"), target:$("fTarget"), eaten:$("fEaten"), burn:$("fBurn"), refeed:$("fRefeed"),
    p:$("fP"), c:$("fC"), f:$("fF"), w:$("fW"), waist:$("fWaist"), notes:$("fNotes")
  };

  let settings = loadSettings();
  let viewDate = new Date(); // current month view
  let rows = null;
  let selectedIndex = -1;

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1600);
  }

  function init() {
    // headers
    calHead.innerHTML = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(d=>`<div class="dow">${d}</div>`).join("");

    // load or create
    const stored = loadData();
    if (stored && stored.rows && stored.month) {
      rows = stored.rows.map(normalizeRow);
      viewDate = new Date(stored.month + "-01T00:00:00");
    } else {
      // default: current month, but also merge Feb 2026 seeded if you are in Feb 2026
      rows = getOrCreateMonth(new Date());
      rows = mergeByDate(rows, SEEDED_ROWS);
      saveData({ month: iso(new Date()).slice(0,7), rows });
    }

    
    // Drive prefs + UI
    loadDrivePrefs();
    uiDriveStatus("Off");
    $("btnDrive")?.addEventListener("click", ()=>{ document.getElementById("settingsModal").classList.add("open"); });
    $("driveClientId")?.addEventListener("change", saveDrivePrefs);
    $("driveAutoSync")?.addEventListener("change", saveDrivePrefs);
    $("btnDriveConnect")?.addEventListener("click", async ()=>{ await driveConnect(); });
    $("btnDriveDisconnect")?.addEventListener("click", ()=>{ driveDisconnect(); });
    $("btnDrivePush")?.addEventListener("click", ()=>{ drivePushNow(); });
    $("btnDrivePull")?.addEventListener("click", ()=>{ drivePullLatest(); });

renderAll();
  }

  function setMonth(d) {
    viewDate = new Date(d.getFullYear(), d.getMonth(), 1);
    const monthKey = iso(viewDate).slice(0,7);
    const stored = loadData();
    if (stored && stored.month === monthKey) {
      rows = stored.rows.map(normalizeRow);
    } else {
      rows = getOrCreateMonth(viewDate);
      // if Feb 2026, merge seeded sample
      if (monthKey === "2026-02") rows = mergeByDate(rows, SEEDED_ROWS);
      saveData({ month: monthKey, rows });
    }
    renderAll();
  }

  function renderAll() {
    const monthKey = loadData()?.month || iso(viewDate).slice(0,7);
    $("monthPill").textContent = monthKey;
    $("phasePill").textContent = "Phase: " + (settings.phase || "Cut");

    renderCalendar();
    renderRecent();
    renderKPIs();
    drawCharts();
  }

  function renderCalendar() {
    cal.innerHTML = "";
    const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
    const startPad = first.getDay(); // 0..6
    for (let i=0;i<startPad;i++) {
      const empty = document.createElement("div");
      empty.style.visibility="hidden";
      cal.appendChild(empty);
    }

    rows.forEach((r, idx)=> {
      const div = document.createElement("div");
      div.className = "day";
      const dnum = Number(r.Date?.slice(8,10)) || (idx+1);
      const rec = recoveryClass(r.Recovery);
      if (rec) {
        const dot = document.createElement("div");
        dot.className = "dot " + rec;
        div.appendChild(dot);
      }
      const train = (r["Training Type"]||"").replace(/,/g,", ");
      const tgt = Number(r["Calories target"]||"") || inferTargetCalories(r, settings);
      const eaten = Number(r["Calories Eaten"]||"");
      const def = deficit(r);
      const defBadge = def==null ? "" : (def>=500 ? `<span class="badge b-good">Def +${Math.round(def)}</span>` : (def>=200 ? `<span class="badge b-warn">Def +${Math.round(def)}</span>` : `<span class="badge b-bad">Def +${Math.round(def)}</span>`));
      const refeed = (r["Re-feed Day"]==="Yes") ? `<span class="badge b-accent">Refeed</span>` : "";
      div.innerHTML += `
        <div class="d">${dnum}</div>
        <div class="meta">
          <span class="badge">${r.Day||""}</span>
          ${train ? `<span class="badge">${train}</span>` : `<span class="badge">—</span>`}
          <span class="badge">Tgt ${tgt}</span>
          ${eaten ? `<span class="badge">Eat ${eaten}</span>` : ""}
          ${refeed}
          ${defBadge}
        </div>
      `;
      div.addEventListener("click", ()=>openDay(idx));
      cal.appendChild(div);
    });
  }

  function renderRecent() {
    // show last 10 days from current month (or all if fewer)
    const last = rows.slice(-10).reverse();
    recentBody.innerHTML = last.map(r=> {
      const tgt = Number(r["Calories target"]||"") || inferTargetCalories(r, settings);
      const eaten = Number(r["Calories Eaten"]||"") || "";
      const burn = Number(r["Total Burn"]||"") || "";
      const def = deficit(r);
      const defTxt = def==null ? "" : (def>=0 ? `+${Math.round(def)}` : `${Math.round(def)}`);
      return `
        <tr>
          <td><b>${r.Date}</b><div class="small">${r.Day||""}</div></td>
          <td>${(r["Training Type"]||"").replace(/,/g,", ")||"—"}</td>
          <td>${r.Recovery||"—"}</td>
          <td class="right">${tgt}</td>
          <td class="right">${eaten}</td>
          <td class="right">${burn}</td>
          <td class="right">${defTxt}</td>
          <td class="right">${r["Protein (g)"]||""}</td>
          <td>${(r.Notes||"").slice(0,70)}</td>
        </tr>
      `;
    }).join("");
  }

  function avg(nums) {
    const v = nums.filter(x=>Number.isFinite(x));
    if (!v.length) return null;
    return v.reduce((a,b)=>a+b,0)/v.length;
  }

  function renderKPIs() {
    const last7 = rows.slice(-7);
    const avgCal = avg(last7.map(r=>Number(r["Calories Eaten"])));
    const avgProt = avg(last7.map(r=>Number(r["Protein (g)"])));
    const w = last7.map(r=>Number(r["Weight (kg)"])).filter(Number.isFinite);
    const wTrend = (w.length>=2) ? (w[w.length-1] - w[0]) : null;

    const avgTarget = avg(last7.map(r=>Number(r["Calories target"]||inferTargetCalories(r, settings))));
    $("kAvgCal").textContent = avgCal==null ? "—" : Math.round(avgCal);
    $("kAvgCalS").textContent = "Target: " + (avgTarget==null ? "—" : Math.round(avgTarget));

    $("kAvgP").textContent = avgProt==null ? "—" : Math.round(avgProt) + " g";
    $("kAvgPS").textContent = "Target: " + settings.protein_g + " g";

    $("kWt").textContent = (wTrend==null) ? "—" : ((wTrend<=0 ? "" : "+") + wTrend.toFixed(1) + " kg");
    $("kWtS").textContent = "7d change";

    const suggestion = shouldSuggestRefeed();
    $("kRefeed").textContent = suggestion ? "Consider" : "No";
    $("kRefeedS").textContent = suggestion ? suggestion : "—";
  }

  function shouldSuggestRefeed() {
    const rule = settings.refeed_rule;
    if (rule==="off") return null;

    const n = rows.length;
    const getRec = (i)=> (rows[i]?.Recovery||"").toLowerCase();
    const getStr = (i)=> Number(rows[i]?.["WHOOP Strain"] || "");
    const tgt = (i)=> Number(rows[i]?.["Calories target"] || inferTargetCalories(rows[i], settings));
    const eat = (i)=> Number(rows[i]?.["Calories Eaten"] || "");

    if (rule==="recovery2red" && n>=2) {
      if (getRec(n-1)==="red" && getRec(n-2)==="red") return "2× Red recovery";
    }
    if (rule==="recovery3yellow" && n>=3) {
      const bad = ["yellow","red"];
      if (bad.includes(getRec(n-1)) && bad.includes(getRec(n-2)) && bad.includes(getRec(n-3))) return "3× Yellow/Red recovery";
    }
    if (rule==="strainHighLowCal" && n>=1) {
      const s = getStr(n-1);
      const t = tgt(n-1);
      const e = eat(n-1);
      if (Number.isFinite(s) && s>=15 && Number.isFinite(e) && e <= (t-400)) return "High strain + low intake";
    }
    return null;
  }

  function drawLine(canvas, xs, ys) {
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    // background grid
    ctx.globalAlpha = 1;
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    for (let i=1;i<5;i++) {
      const y = (H/5)*i;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
    const pts = ys.map((y,i)=>({x: (xs.length<=1?0:(W*(i/(xs.length-1)))), y}));
    const vals = ys.filter(Number.isFinite);
    if (vals.length<2) return;

    const min = Math.min(...vals);
    const max = Math.max(...vals);
    const pad = (max-min)*0.15 || 1;
    const yMap = (v)=> {
      const t = (v - (min-pad)) / ((max+pad)-(min-pad));
      return H - (t*H);
    };

    ctx.lineWidth = 2.2;
    ctx.strokeStyle = "rgba(74,163,255,0.95)";
    ctx.beginPath();
    let started=false;
    ys.forEach((v,i)=> {
      if (!Number.isFinite(v)) return;
      const x = pts[i].x;
      const y = yMap(v);
      if (!started) { ctx.moveTo(x,y); started=true; }
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle = "rgba(42,211,125,0.95)";
    ys.forEach((v,i)=> {
      if (!Number.isFinite(v)) return;
      const x = pts[i].x;
      const y = yMap(v);
      ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
    });
  }

  function drawCharts() {
    const last14 = rows.slice(-14);
    const xs = last14.map((r,i)=>i);
    const w = last14.map(r=>Number(r["Weight (kg)"]));
    drawLine($("wtChart"), xs, w);

    // calories eaten vs target -> draw difference (eaten - target)
    const dif = last14.map(r=> {
      const e = Number(r["Calories Eaten"]);
      const t = Number(r["Calories target"]||inferTargetCalories(r, settings));
      if (!Number.isFinite(e)) return NaN;
      return e - t;
    });
    drawLine($("calChart"), xs, dif);
  }

  function openDay(idx) {
    selectedIndex = idx;
    const r = rows[idx];
    $("mTitle").textContent = `${r.Date} • ${r.Day||""}`;
    $("mSub").textContent = (r["Training Type"]||"").replace(/,/g,", ") || "—";

    fields.date.value = r.Date || "";
    fields.day.value = r.Day || "";
    fields.train.value = (r["Training Type"]||"");
    fields.strain.value = r["WHOOP Strain"] || "";
    fields.recovery.value = r.Recovery || "";
    fields.phase.value = r.Phase || "Cut";
    fields.target.value = r["Calories target"] || "";
    fields.eaten.value = r["Calories Eaten"] || "";
    fields.burn.value = r["Total Burn"] || "";
    fields.refeed.value = r["Re-feed Day"] || "";
    fields.p.value = r["Protein (g)"] || "";
    fields.c.value = r["Carbs (g)"] || "";
    fields.f.value = r["Fat (g)"] || "";
    fields.w.value = r["Weight (kg)"] || "";
    fields.waist.value = r["Waist (cm)"] || "";
    fields.notes.value = r.Notes || "";

    updateDeficitPill();
    dayModal.classList.add("open");
  }

  function closeDay() {
    dayModal.classList.remove("open");
    selectedIndex = -1;
  }

  function openSettings() {
    if($("sMode")) $("sMode").value = settings.mode || DEFAULT_SETTINGS.mode;
    $("sRest").value = settings.cals_rest;
    $("sGym").value = settings.cals_gym;
    $("sSport").value = settings.cals_sport;
    $("sRefeed").value = settings.cals_refeed;
    $("sProt").value = settings.protein_g;
    $("sFat").value = settings.fat_g;
    $("sRefeedRule").value = settings.refeed_rule;
    renderRuleCard();
    settingsModal.classList.add("open");
  }

  function closeSettings() {
    settingsModal.classList.remove("open");
  }

  function renderRuleCard() {
    const txt = `
      <b>Daily rule (11–14% cut)</b><br/>
      1) Hit <b>${settings.protein_g}g protein</b> daily (non‑negotiable).<br/>
      2) Calories by day type:<br/>
      • Rest: <b>${settings.cals_rest}</b> • Gym: <b>${settings.cals_gym}</b> • Sport (padel/football): <b>${settings.cals_sport}</b><br/>
      3) If Recovery stays low (trigger: <b>${settings.refeed_rule}</b>) → do 1× Refeed at <b>${settings.cals_refeed}</b> (carbs up, fats steady).<br/>
      4) Weekly check: if 7‑day avg weight not dropping → reduce all targets by 150–200.
    `;
    $("ruleCardText").innerHTML = txt;
  }

  function updateDeficitPill() {
    if (selectedIndex<0) return;
    const burn = Number(fields.burn.value||"");
    const eaten = Number(fields.eaten.value||"");
    const d = (burn && eaten) ? (burn - eaten) : null;
    $("mDeficitPill").textContent = d==null ? "Deficit: —" : `Deficit: ${d>=0?"+":""}${Math.round(d)} kcal`;
  }

  function saveDay() {
    if (selectedIndex<0) return;
    const r = rows[selectedIndex];
    r.Date = fields.date.value;
    r.Day = fields.day.value || dayName(new Date(fields.date.value+"T00:00:00"));
    r["Training Type"] = (fields.train.value||"").replace(/\s+/g,"").replace(/,+/g,",").replace(/^,|,$/g,"");
    r["WHOOP Strain"] = fields.strain.value || "";
    r.Recovery = fields.recovery.value || "";
    r.Phase = fields.phase.value || "Cut";
    r["Calories target"] = fields.target.value || "";
    r["Calories Eaten"] = fields.eaten.value || "";
    r["Total Burn"] = fields.burn.value || "";
    r["Re-feed Day"] = fields.refeed.value || "";
    r["Protein (g)"] = fields.p.value || "";
    r["Carbs (g)"] = fields.c.value || "";
    r["Fat (g)"] = fields.f.value || "";
    r["Weight (kg)"] = fields.w.value || "";
    r["Waist (cm)"] = fields.waist.value || "";
    r.Notes = fields.notes.value || "";

    // keep sorted
    rows.sort((a,b)=>a.Date.localeCompare(b.Date));
    // persist
    const monthKey = iso(viewDate).slice(0,7);
    saveData({month: monthKey, rows});
    showToast("Saved");
    closeDay();
    renderAll();
  }

  function autofillTargets() {
    if (selectedIndex<0) return;
    const r = rows[selectedIndex];
    const macro = inferMacros(r, settings);
    fields.target.value = macro.target;
    if (!fields.p.value) fields.p.value = macro.p;
    if (!fields.f.value) fields.f.value = macro.f;
    if (!fields.c.value) fields.c.value = macro.c;
    updateDeficitPill();
    showToast("Autofilled");
  }

  // ---------- Export/Import ----------
  function exportJSON() {
    const payload = {
      month: iso(viewDate).slice(0,7),
      rows,
      settings
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `fatloss_${payload.month}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  async function importJSON() {
    const inp = document.createElement("input");
    inp.type="file"; inp.accept=".json,application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if (!file) return;
      const text = await file.text();
      try {
        const payload = JSON.parse(text);
        if (payload.rows && payload.month) {
          rows = payload.rows.map(normalizeRow);
          viewDate = new Date(payload.month + "-01T00:00:00");
          if (payload.settings) {
            settings = {...DEFAULT_SETTINGS, ...payload.settings};
            saveSettings(settings);
          }
          saveData({month: payload.month, rows});
          showToast("Imported");
          renderAll();
        } else {
          alert("Invalid file: missing rows/month");
        }
      } catch(e) {
        alert("Could not import: " + e.message);
      }
    };
    inp.click();
  }

  function resetAll() {
    if (!confirm("Reset local data for this tracker?")) return;
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_SETTINGS);
    settings = loadSettings();
    setMonth(new Date());
    showToast("Reset");
  }

  // ---------- Events ----------
  $("btnClose").addEventListener("click", closeDay);
  $("btnSave").addEventListener("click", saveDay);
  $("btnAutofill").addEventListener("click", autofillTargets);

  ["fBurn","fEaten"].forEach(id => $(id).addEventListener("input", updateDeficitPill));

  $("btnSettings").addEventListener("click", openSettings);
  $("btnCloseSettings").addEventListener("click", closeSettings);
  $("btnSaveSettings").addEventListener("click", ()=> {
    settings = {
      ...settings,
      cals_rest: Number($("sRest").value||DEFAULT_SETTINGS.cals_rest),
      cals_gym: Number($("sGym").value||DEFAULT_SETTINGS.cals_gym),
      cals_sport: Number($("sSport").value||DEFAULT_SETTINGS.cals_sport),
      cals_refeed: Number($("sRefeed").value||DEFAULT_SETTINGS.cals_refeed),
      protein_g: Number($("sProt").value||DEFAULT_SETTINGS.protein_g),
      fat_g: Number($("sFat").value||DEFAULT_SETTINGS.fat_g),
      refeed_rule: $("sRefeedRule").value
    };
    saveSettings(settings);
    renderRuleCard();
    closeSettings();
    showToast("Saved targets");
    renderAll();
  });


  function applyMode(mode, persist=true){
    const preset = MODE_PRESETS[mode] || MODE_PRESETS.fatloss;
    settings.mode = mode;
    settings.phase = preset.phase;
    settings.cals_rest = preset.cals_rest;
    settings.cals_gym = preset.cals_gym;
    settings.cals_sport = preset.cals_sport;
    settings.cals_refeed = preset.cals_refeed;
    settings.protein_g = preset.protein_g;
    settings.fat_g = preset.fat_g;
    if(persist){ saveSettings(settings); }
    // reflect in UI
    document.querySelectorAll(".modebtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.mode===mode);
    });
    const phasePill = document.getElementById("phasePill");
    if(phasePill) phasePill.textContent = "Phase: " + settings.phase;
    if(document.getElementById("sPhase")) document.getElementById("sPhase").value = settings.phase;
    if(document.getElementById("sMode")) document.getElementById("sMode").value = mode;
    renderRuleCard();
    renderAll();
  }

  document.querySelectorAll(".modebtn").forEach(b=>{
    b.addEventListener("click", ()=>applyMode(b.dataset.mode, true));
  });

  const btnApplyMode = document.getElementById("btnApplyMode");
  if(btnApplyMode){
    btnApplyMode.addEventListener("click", (e)=>{
      e.preventDefault();
      const mode = (document.getElementById("sMode")?.value) || "fatloss";
      applyMode(mode, true);
      openSettings(); // re-fill values after preset
    });
  }

  // set initial active state
  document.addEventListener("DOMContentLoaded", ()=>{
    applyMode(settings.mode || DEFAULT_SETTINGS.mode, false);
  });


  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", importJSON);
  $("btnReset").addEventListener("click", resetAll);

  $("btnToday").addEventListener("click", ()=> {
    const now = new Date();
    if (now.getFullYear()!==viewDate.getFullYear() || now.getMonth()!==viewDate.getMonth()) {
      setMonth(now);
      return;
    }
    // open today if exists
    const todayIso = iso(now);
    const idx = rows.findIndex(r=>r.Date===todayIso);
    if (idx>=0) openDay(idx);
  });

  // Close modals on backdrop click
  dayModal.addEventListener("click", (e)=>{ if(e.target===dayModal) closeDay(); });
  settingsModal.addEventListener("click", (e)=>{ if(e.target===settingsModal) closeSettings(); });

  // Init
  settings = loadSettings();
  init();
</script>

<script>
/* ===== v2 ADDITIONS =====
1) Monthly versioned backups to Drive
2) CSV export/import
3) Dashboard KPIs: 7-day deficit, weight trend, adherence
========================== */

/* --- Monthly folder naming --- */
function getMonthKey(d){
  const dt = new Date(d||Date.now());
  return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,'0');
}

/* --- Versioned filename --- */
function versionedName(){
  const m = getMonthKey();
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  return `fatloss_${m}_${ts}.json`;
}

/* --- CSV Export --- */
function exportCSV(){
  const data = loadData();
  if(!data.length){ alert("No data"); return; }
  const cols = Object.keys(data[0]||{});
  const rows = [cols.join(",")].concat(
    data.map(r=>cols.map(c=>`"${(r[c]??"").toString().replace(/"/g,'""')}"`).join(","))
  );
  const blob = new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`bodycomp_export_${getMonthKey()}.csv`;
  a.click();
}

function importCSV(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const lines=reader.result.split(/\r?\n/).filter(Boolean);
      const head=lines.shift().split(",").map(h=>h.trim());
      const data=lines.map(line=>{
        const vals=line.split(",").map(v=>v.replace(/^"|"$/g,"").replace(/""/g,'"'));
        const o={}; head.forEach((h,i)=>o[h]=vals[i]??""); return o;
      });
      saveData(data);
      location.reload();
    }catch(e){
      alert("CSV import failed");
    }
  };
  reader.readAsText(file);
}

/* --- Dashboard KPIs --- */
  const _charts = { macro:null, adh:null };
  function setKPI(id, val){
    const el=document.getElementById(id);
    if(el) el.textContent = val;
  }
  function drawPies(macros, adh){
    // Macros pie
    const ctx1=document.getElementById("macroPie");
    if(ctx1 && window.Chart){
      const data = macros ? [macros.protein||0, macros.carbs||0, macros.fat||0] : [0,0,0];
      if(_charts.macro) _charts.macro.destroy();
      _charts.macro = new Chart(ctx1, {
        type:"pie",
        data:{ labels:["Protein","Carbs","Fat"], datasets:[{ data }] },
        options:{ responsive:true, plugins:{ legend:{ position:"bottom" } } }
      });
    }
    // Adherence pie
    const ctx2=document.getElementById("adhPie");
    if(ctx2 && window.Chart){
      const ok = adh ? adh.ok : 0;
      const miss = adh ? (adh.miss-ok) : 0;
      if(_charts.adh) _charts.adh.destroy();
      _charts.adh = new Chart(ctx2, {
        type:"doughnut",
        data:{ labels:["On target (±100)","Off target"], datasets:[{ data:[ok, miss] }] },
        options:{ responsive:true, plugins:{ legend:{ position:"bottom" } }, cutout:"60%" }
      });
    }
  }


function computeKPIs(){
    const d = loadData();
    const last7 = d.slice(-7);
    if(!last7.length){
      setKPI('kDef', 0);
      setKPI('kWt', '—');
      setKPI('kAdh', '0%');
      drawPies(null, null);
      return;
    }
    const num = (v)=>{ const n=parseFloat(v); return Number.isFinite(n)?n:0; };
    const avgDef = Math.round(last7.reduce((s,r)=>s+(num(r["Total Burn"])-num(r["Calories Eaten"])),0)/last7.length);
    const wtTrend = (()=>{
      const w = last7.map(r=>num(r["Weight (kg)"])).filter(x=>x>0);
      if(w.length<2) return "—";
      return (w[w.length-1]-w[0]).toFixed(1)+" kg";
    })();
    const adh = Math.round(100*last7.filter(r=>Math.abs(num(r["Calories Eaten"])-num(r["Calories Target"]))<=100).length/last7.length);

    setKPI('kDef', avgDef);
    setKPI('kWt', wtTrend);
    setKPI('kAdh', adh+"%");

    // today macros pie (last row)
    const t = d[d.length-1] || {};
    const macros = {
      protein: num(t["Protein (g)"]),
      carbs: num(t["Carbs (g)"]),
      fat: num(t["Fat (g)"])
    };
    // adherence pie (7d)
    const adhPie = { ok: last7.filter(r=>Math.abs(num(r["Calories Eaten"])-num(r["Calories Target"]))<=100).length, miss: last7.length };
    drawPies(macros, adhPie);
  }
document.addEventListener("DOMContentLoaded", computeKPIs);
</script>

</body>
</html>
