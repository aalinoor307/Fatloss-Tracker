<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Body Composition Control — Phase 1</title>
<meta name="theme-color" content="#0b0f17"/>
<style>
:root{
  --bg:#0b0f17; --panel:#0f1624; --panel2:#121c2e; --text:#e8edf6; --muted:#9aa7bd;
  --line:#1f2a40; --good:#2ad37d; --warn:#ffcc66; --bad:#ff5b5b; --accent:#4aa3ff;
  --shadow:0 16px 45px rgba(0,0,0,.45);
  --r:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(1200px 800px at 18% 6%, rgba(74,163,255,.18), transparent 55%),
             radial-gradient(900px 700px at 82% 20%, rgba(42,211,125,.10), transparent 55%),
             linear-gradient(180deg, #070b12, var(--bg));
  color:var(--text);
}
a{color:inherit}
.wrap{max-width:1200px;margin:0 auto;padding:18px 16px 44px}
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg, rgba(74,163,255,.9), rgba(42,211,125,.8)); box-shadow:0 12px 30px rgba(0,0,0,.35)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill, button{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--text);
  border-radius:999px;
  padding:9px 12px;
  font-size:12px;
  cursor:pointer;
  user-select:none;
}
.pill.active{border-color:rgba(74,163,255,.55); box-shadow:0 0 0 3px rgba(74,163,255,.12) inset}
button.primary{background:linear-gradient(135deg, rgba(74,163,255,.95), rgba(74,163,255,.55)); border-color:transparent}
button.danger{background:linear-gradient(135deg, rgba(255,91,91,.95), rgba(255,91,91,.55)); border-color:transparent}
button.ghost{background:rgba(255,255,255,.02)}
.row{display:grid;grid-template-columns:1.4fr .9fr;gap:14px;margin-top:14px}
@media (max-width: 980px){.row{grid-template-columns:1fr}}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
.card .hd .t{font-weight:700;font-size:13px}
.card .bd{padding:14px}
.gridKpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width: 980px){.gridKpi{grid-template-columns:repeat(2,1fr)}}
.kpi{padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.22)}
.kpi .k{font-size:11px;color:var(--muted)}
.kpi .v{font-size:18px;font-weight:800;margin-top:4px}
.kpi .s{font-size:11px;color:var(--muted);margin-top:2px}
.twoCharts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
@media (max-width: 980px){.twoCharts{grid-template-columns:1fr}}
.chartBox{padding:10px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.22)}
.chartBox .ct{font-size:11px;color:var(--muted);margin:0 0 8px 0}
canvas{width:100%;height:170px;display:block}
.bigCanvas{height:210px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
.dow div{font-size:11px;color:var(--muted);text-align:center}
.day{
  min-height:88px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.20);
  padding:10px;
  cursor:pointer;
  position:relative;
}
.day:hover{border-color:rgba(74,163,255,.55)}
.day .n{font-weight:800;font-size:12px}
.badgeRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:7px}
.badge{font-size:10px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:rgba(255,255,255,.02)}
.badge.good{color:rgba(42,211,125,.95);border-color:rgba(42,211,125,.25)}
.badge.warn{color:rgba(255,204,102,.95);border-color:rgba(255,204,102,.25)}
.badge.bad{color:rgba(255,91,91,.95);border-color:rgba(255,91,91,.25)}
.dot{
  position:absolute; top:10px; right:10px;
  width:10px;height:10px;border-radius:50%;
  background:rgba(255,255,255,.12);
}
.dot.on{background:rgba(74,163,255,.75); box-shadow:0 0 0 4px rgba(74,163,255,.12)}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);font-size:12px;text-align:left}
.table th{color:var(--muted);font-weight:600}
.table td .mini{display:block;color:var(--muted);font-size:11px;margin-top:2px}
.rightTools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:11px;color:var(--muted)}
/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;background:rgba(0,0,0,.55);z-index:50}
.modal.on{display:flex}
.sheet{max-width:920px;width:100%;border-radius:18px;border:1px solid var(--line);background:linear-gradient(180deg, rgba(15,22,36,.98), rgba(15,22,36,.92));box-shadow:var(--shadow);overflow:hidden}
.sheet .shd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
.sheet .shd .t{font-weight:800;font-size:13px}
.sheet .sbd{padding:14px}
.form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 880px){.form{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
label{font-size:11px;color:var(--muted)}
input,select,textarea{
  background:rgba(0,0,0,.25);
  border:1px solid var(--line);
  color:var(--text);
  padding:10px 10px;
  border-radius:12px;
  outline:none;
}
textarea{min-height:84px;resize:vertical}
.hr{height:1px;background:var(--line);margin:12px 0}
.ruleCard{
  border:1px dashed rgba(74,163,255,.35);
  border-radius:14px;
  padding:12px;
  background:rgba(74,163,255,.05);
  font-size:12px;
  line-height:1.35;
}
.ruleCard b{color:var(--text)}
.warnBox{
  border:1px solid rgba(255,204,102,.25);
  background:rgba(255,204,102,.06);
  border-radius:14px;
  padding:10px;
  color:var(--muted);
  font-size:12px;
}
</style>

  <!-- Google Drive sync (Phase 3) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Body Composition Control</h1>
        <div class="sub">Fat loss • Weight loss • Weight gain — single-file tracker (local storage) • Phase 1 (profile → math → targets)</div>
      </div>
    </div>
    <div class="pills" id="modePills">
      <div class="pill active" data-mode="fatloss">Fat loss</div>
      <div class="pill" data-mode="weightloss">Weight loss</div>
      <div class="pill" data-mode="weightgain">Weight gain</div>
    </div>
  </div>

  <div class="pills" style="margin-top:10px">
    <button class="ghost" id="btnPrev">◀</button>
    <button class="ghost" id="btnNext">▶</button>
    <div class="pill" id="monthLabel" style="cursor:default"></div>
    <button class="ghost" id="btnToday">Today</button>
    <button class="ghost" id="btnProfile">Profile</button>
    
          <button class="btn" id="btnDrive" title="Sync backups to Google Drive (requires sign-in)">Drive: Off</button>
<span class="small" style="padding:0 6px">•</span>
    <button class="ghost" id="btnExportJSON">Export JSON</button>
    <button class="ghost" id="btnExportCSV">Export CSV</button>
    <label class="pill" style="display:flex;gap:8px;align-items:center;cursor:pointer">
      Import <input type="file" id="fileImport" accept=".json,.csv" style="display:none"/>
    </label>
    <button class="ghost" id="btnSnapshot">Monthly Snapshot</button>
    <button class="danger" id="btnReset">Reset</button>
  </div>

  <div class="row">
    <div class="card">
      <div class="hd">
        <div class="t">This Month</div>
        <div class="rightTools">
          <span class="small" id="computedTargetLine">Target: —</span>
        </div>
      </div>
      <div class="bd">
        <div class="dow">
          <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div class="calendar" id="cal"></div>
        <div class="small" style="margin-top:10px">Click any day to edit. Data saves automatically (local). Targets auto-calc from Profile + Mode. You can override per day.</div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="t">Dashboard</div>
        <div class="rightTools">
          <span class="pill" id="phaseLabel" style="cursor:default">Phase: Cut</span>
        </div>
      </div>
      <div class="bd">
        <div class="gridKpi">
  <div class="kpi">
    <div class="k">Today's target</div>
    <div class="v" id="kTarget">—</div>
    <div class="s">kcal/day</div>
  </div>
  <div class="kpi">
    <div class="k">TDEE estimate</div>
    <div class="v" id="kTdee">—</div>
    <div class="s">kcal/day</div>
  </div>
  <div class="kpi">
    <div class="k">Today deficit / surplus</div>
    <div class="v" id="kToday">—</div>
    <div class="s">burn − eaten</div>
  </div>
  <div class="kpi">
    <div class="k" id="kDefT">Avg deficit / surplus (7d)</div>
    <div class="v" id="kDef">—</div>
    <div class="s" id="kDefS">Per day</div>
  </div>
  <div class="kpi">
    <div class="k">Weight trend (7d)</div>
    <div class="v" id="kWt">—</div>
    <div class="s">7‑day change</div>
  </div>
  <div class="kpi">
    <div class="k">Adherence (7d)</div>
    <div class="v" id="kAdh">—</div>
    <div class="s">Within ±100 kcal target</div>
  </div>
</div>
<div class="twoCharts">
          <div class="chartBox">
            <p class="ct">Weight trend (last 14 entries)</p>
            <canvas id="cWeight" class="bigCanvas" width="700" height="240"></canvas>
          </div>
          <div class="chartBox">
            <p class="ct">Deficit / surplus (last 14 entries)</p>
            <canvas id="cDef" class="bigCanvas" width="700" height="240"></canvas>
          </div>
        </div>

        <div class="twoCharts">
          <div class="chartBox">
            <p class="ct">Macros (last entry)</p>
            <canvas id="cPie" width="700" height="220"></canvas>
          </div>
          <div class="chartBox">
            <p class="ct">No-think rule card</p>
            <div class="ruleCard" id="ruleCard"></div>
          </div>
        </div>

        <div class="warnBox" style="margin-top:10px">
          Math is only as good as your inputs. Use this correctly: <b>Deficit = Total Burn (TDEE) − Calories Eaten</b>. Gym calories alone are not TDEE.
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="hd">
      <div class="t">Recent entries</div>
      <div class="small">Shows last 10 saved days</div>
    </div>
    <div class="bd" style="padding-top:0">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Date</th><th>Mode</th><th>Target</th><th>Eaten</th><th>Total Burn</th><th>Deficit</th><th>Weight</th><th>Body fat</th><th>Protein</th><th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Day Editor -->
<div class="modal" id="mDay" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="shd">
      <div class="t" id="dayTitle">Edit day</div>
      <div class="pills">
        <button class="primary" id="btnSaveDay">Save</button>
        <button class="ghost" id="btnCloseDay">✕</button>
      </div>
    </div>
    <div class="sbd">
      <div class="form">
        <div class="field">
          <label>Mode</label>
          <select id="dMode">
            <option value="fatloss">Fat loss</option>
            <option value="weightloss">Weight loss</option>
            <option value="weightgain">Weight gain</option>
          </select>
        </div>
        <div class="field">
          <label>Training</label>
          <select id="dTrain">
            <option value="rest">Rest</option>
            <option value="gym">Gym</option>
            <option value="sport">Football / Padel</option>
            <option value="walk">Walk / Swim</option>
          </select>
        </div>

        <div class="field">
          <label>Calorie target (kcal) — auto-filled, can override</label>
          <input id="dTarget" inputmode="numeric" placeholder="e.g. 2500"/>
        </div>
        <div class="field">
          <label>Calories eaten (kcal)</label>
          <input id="dEaten" inputmode="numeric" placeholder="e.g. 2300"/>
        </div>

        <div class="field">
          <label>Total burn / TDEE (kcal)</label>
          <input id="dBurn" inputmode="numeric" placeholder="e.g. 3200"/>
        </div>
        <div class="field">
          <label>Deficit / surplus (auto)</label>
          <input id="dDef" disabled/>
        </div>

        <div class="field">
          <label>Weight (kg)</label>
          <input id="dWt" inputmode="decimal" placeholder="e.g. 84.2"/>
        </div>
        <div class="field">
          <label>Body fat % (optional)</label>
          <input id="dBf" inputmode="decimal" placeholder="e.g. 16.5"/>
        </div>

        <div class="field">
          <label>Protein (g)</label>
          <input id="dP" inputmode="numeric" placeholder="e.g. 200"/>
        </div>
        <div class="field">
          <label>Carbs (g)</label>
          <input id="dC" inputmode="numeric" placeholder="e.g. 220"/>
        </div>
        <div class="field">
          <label>Fat (g)</label>
          <input id="dF" inputmode="numeric" placeholder="e.g. 70"/>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Notes</label>
          <textarea id="dNotes" placeholder="Anything relevant (sleep, cravings, performance, travel...)"></textarea>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small">
        Auto guidance: if you enter <b>Profile</b>, targets will be computed precisely. If you leave Profile blank, targets are generic.
      </div>
    </div>
  </div>
</div>

<!-- Profile -->
<div class="modal" id="mProfile" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="shd">
      <div class="t">Profile → math → targets</div>
      <div class="pills">
        <button class="primary" id="btnSaveProfile">Save</button>
        <button class="ghost" id="btnCloseProfile">✕</button>
      </div>
    </div>
    <div class="sbd">
      <div class="form">
        <div class="field">
          <label>Sex</label>
          <select id="pSex">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="field">
          <label>Age</label>
          <input id="pAge" inputmode="numeric" placeholder="e.g. 28"/>
        </div>
        <div class="field">
          <label>Height (cm)</label>
          <input id="pH" inputmode="numeric" placeholder="e.g. 178"/>
        </div>
        <div class="field">
          <label>Current weight (kg)</label>
          <input id="pW" inputmode="decimal" placeholder="e.g. 84.0"/>
        </div>
        <div class="field">
          <label>Current body fat %</label>
          <input id="pBf" inputmode="decimal" placeholder="e.g. 16.0"/>
        </div>
        <div class="field">
          <label>Activity level (non-workout)</label>
          <select id="pAct">
            <option value="1.2">Sedentary (desk)</option>
            <option value="1.375">Light (walks)</option>
            <option value="1.55" selected>Moderate (active)</option>
            <option value="1.725">Very active</option>
            <option value="1.9">Athlete</option>
          </select>
        </div>

        <div class="field">
          <label>Goal weight (kg)</label>
          <input id="pGW" inputmode="decimal" placeholder="optional"/>
        </div>
        <div class="field">
          <label>Goal body fat %</label>
          <input id="pGBf" inputmode="decimal" placeholder="optional"/>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Preview (auto)</label>
          <div class="ruleCard" id="profilePreview"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="small">
        Targets use Mifflin-St Jeor BMR → TDEE (BMR × activity). Mode adds deficit/surplus. Training only changes recommended buffer slightly; your <b>Total Burn</b> input is what determines actual deficit.
      </div>
    </div>
  </div>
</div>

<script>

/* ===== Storage ===== */
const LS_PROFILE = "bc_profile_v1";
const LS_ENTRIES = "bc_entries_v1";
const LS_UI      = "bc_ui_v1";

/* ===== Utilities ===== */
const pad2 = n => String(n).padStart(2,"0");
const fmtDate = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const toNum = (x)=>{ const n = parseFloat(String(x||"").replace(/,/g,"")); return Number.isFinite(n)?n:null; };

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    const v = JSON.parse(raw);
    return v ?? fallback;
  }catch(_){ return fallback; }
}
function saveJSON(key, v){ localStorage.setItem(key, JSON.stringify(v)); }

/* ===== Profile + Math ===== */
function defaultProfile(){
  return {
    sex:"male", age:null, heightCm:null, weightKg:null, bodyFatPct:null,
    activity:1.55, goalWeightKg:null, goalBodyFatPct:null
  };
}
function getProfile(){ return {...defaultProfile(), ...loadJSON(LS_PROFILE, {})}; }

function bmrMifflin(p){
  const w = toNum(p.weightKg), h = toNum(p.heightCm), a = toNum(p.age);
  if(w==null||h==null||a==null) return null;
  const base = 10*w + 6.25*h - 5*a;
  return Math.round(base + (p.sex==="female" ? -161 : 5));
}
function tdee(p){
  const b = bmrMifflin(p);
  if(b==null) return null;
  const act = toNum(p.activity) ?? 1.55;
  return Math.round(b * act);
}

// Mode plan: return {phaseLabel, targetKcal, proteinG, deficitOrSurplusKcal, weeklyKg}
function planFor(mode, p){
  const T = tdee(p);
  // Fallback if profile incomplete
  const fallback = {
    fatloss:{phase:"Cut", target:2400, prot:200, delta:-600, weekly:-0.55},
    weightloss:{phase:"Cut", target:2300, prot:190, delta:-700, weekly:-0.65},
    weightgain:{phase:"Bulk", target:2900, prot:170, delta:+300, weekly:+0.27},
  }[mode] || {phase:"Cut", target:2400, prot:200, delta:-600, weekly:-0.55};

  if(T==null){
    return {phase:fallback.phase, targetKcal:fallback.target, proteinG:fallback.prot, deltaKcal:fallback.delta, weeklyKg:fallback.weekly, tdee:null, bmr:null};
  }

  const b = bmrMifflin(p);
  let delta;
  if(mode==="weightgain"){
    delta = clamp(Math.round(0.12*T), 200, 500);
  }else if(mode==="weightloss"){
    delta = clamp(Math.round(0.25*T), 500, 1000);
    delta = -delta;
  }else{
    delta = clamp(Math.round(0.22*T), 400, 800);
    delta = -delta;
  }
  const target = Math.round(T + delta);
  // Protein: 2.0g/kg for cut, 1.6g/kg for gain (fallback to 180)
  const w = toNum(p.weightKg);
  let prot = 180;
  if(w!=null){
    prot = Math.round((mode==="weightgain" ? 1.6 : 2.0) * w);
    prot = clamp(prot, 120, 260);
  }
  const weeklyKg = (delta*7)/7700; // negative for loss, positive for gain
  return {
    phase: (mode==="weightgain" ? "Bulk" : "Cut"),
    targetKcal: target,
    proteinG: prot,
    deltaKcal: delta,
    weeklyKg: Math.round(weeklyKg*100)/100,
    tdee:T, bmr:b
  };
}

function makeRuleCard(mode, p){
  const pl = planFor(mode,p);
  const sign = pl.deltaKcal>=0 ? "+" : "";
  const goal = (pl.weeklyKg>=0 ? "+" : "") + pl.weeklyKg + " kg/week (estimate)";
  return `
<b>Mode:</b> ${mode==="fatloss"?"Fat loss":mode==="weightloss"?"Weight loss":"Weight gain"}<br/>
<b>Daily target:</b> ${pl.targetKcal} kcal (${sign}${pl.deltaKcal} vs TDEE)<br/>
<b>Protein target:</b> ${pl.proteinG} g/day<br/>
<b>Weekly rate:</b> ${goal}<br/><br/>
<b>Daily execution:</b><br/>
1) Enter morning weight (and body fat if you have it)<br/>
2) Log calories eaten + total burn (TDEE)<br/>
3) Deficit = burn − eaten (ignore “workout calories”)<br/>
4) Adjust only if 14-day trend stalls
  `.trim();
}

/* ===== Entries Model =====
Entry shape:
{ date:"YYYY-MM-DD", mode, training, target, eaten, burn, weight, bodyfat, protein, carbs, fat, notes, updatedAt }
*/
function getEntries(){
  const v = loadJSON(LS_ENTRIES, []);
  return Array.isArray(v) ? v : [];
}
function setEntries(arr){ saveJSON(LS_ENTRIES, arr); }

function upsertEntry(e){
  const arr = getEntries();
  const i = arr.findIndex(x => x.date === e.date);
  if(i>=0) arr[i] = e; else arr.push(e);
  arr.sort((a,b)=>a.date.localeCompare(b.date));
  setEntries(arr);
}
function getEntry(date){
  return getEntries().find(e=>e.date===date) || null;
}

/* ===== UI State ===== */
function defaultUI(){
  const now = new Date();
  return { mode:"fatloss", y: now.getFullYear(), m: now.getMonth() }; // m:0-11
}
function getUI(){ return {...defaultUI(), ...loadJSON(LS_UI,{})}; }
function setUI(u){ saveJSON(LS_UI,u); }

/* ===== Rendering ===== */
const el = (id)=>document.getElementById(id);
const cal = el("cal");
const tblBody = el("tbl").querySelector("tbody");

function monthName(y,m){
  const d = new Date(y,m,1);
  return d.toLocaleString(undefined,{month:"long", year:"numeric"});
}
function mondayFirstIndex(d){ // 0..6 where 0=Mon
  const js = d.getDay(); // 0 Sun
  return (js+6)%7;
}

function calcDayDefaultTarget(mode, training, p){
  const base = planFor(mode,p).targetKcal;
  // small training buffer (not “earned calories”, just practical)
  const adj = {rest:0, gym:100, sport:200, walk:80}[training] ?? 0;
  return base + adj;
}

function render(){
  const ui = getUI();
  const p = getProfile();
  const plan = planFor(ui.mode,p);

  // mode pills
  document.querySelectorAll("#modePills .pill").forEach(x=>{
    x.classList.toggle("active", x.dataset.mode===ui.mode);
  });
  el("phaseLabel").textContent = "Phase: " + plan.phase;
  el("monthLabel").textContent = monthName(ui.y, ui.m);
  el("computedTargetLine").textContent = `Target (base): ${plan.targetKcal} kcal • Protein: ${plan.proteinG}g`;

  // rule card
  el("ruleCard").innerHTML = makeRuleCard(ui.mode,p);

  // calendar
  cal.innerHTML = "";
  const first = new Date(ui.y, ui.m, 1);
  const daysInMonth = new Date(ui.y, ui.m+1, 0).getDate();
  const offset = mondayFirstIndex(first);
  const totalSlots = Math.ceil((offset + daysInMonth)/7)*7;

  const todayKey = fmtDate(new Date());
  for(let slot=0; slot<totalSlots; slot++){
    const dayNum = slot - offset + 1;
    const cell = document.createElement("div");

    if(dayNum<1 || dayNum>daysInMonth){
      cell.style.visibility="hidden";
      cell.className="day";
      cal.appendChild(cell);
      continue;
    }

    const date = fmtDate(new Date(ui.y, ui.m, dayNum));
    const entry = getEntry(date);

    const mode = entry?.mode || ui.mode;
    const training = entry?.training || "rest";
    const target = (entry && entry.target!=null) ? entry.target : calcDayDefaultTarget(mode, training, p);
    const eaten = entry?.eaten ?? null;
    const burn = entry?.burn ?? null;
    const hasData = !!entry && (eaten!=null || burn!=null || entry.weight!=null);

    cell.className="day";
    cell.dataset.date = date;
    cell.innerHTML = `
      <div class="dot ${hasData?'on':''}"></div>
      <div class="n">${dayNum}</div>
      <div class="badgeRow">
        <span class="badge">${mode==="fatloss"?"Fat":mode==="weightloss"?"Loss":"Gain"}</span>
        <span class="badge">${training==="rest"?"Rest":training==="gym"?"Gym":training==="sport"?"Sport":"Walk"}</span>
        <span class="badge">${"Tgt "+target}</span>
      </div>
    `;

    if(eaten!=null && burn!=null){
      const def = Math.round(burn - eaten);
      const b = document.createElement("div");
      b.className = "badgeRow";
      const cls = def>=0 ? (def>=500 ? "good" : "warn") : "bad";
      b.innerHTML = `<span class="badge ${cls}">${def>=0?def+" def":"+"+Math.abs(def)+" surplus"}</span>`;
      cell.appendChild(b);
    }

    cal.appendChild(cell);
  }

  // recent table
  const entries = getEntries().slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10);
  tblBody.innerHTML = entries.map(e=>{
    const def = (e.burn!=null && e.eaten!=null) ? Math.round(e.burn - e.eaten) : "";
    return `
      <tr>
        <td><b>${e.date}</b><span class="mini">${new Date(e.date).toLocaleDateString(undefined,{weekday:"short"})}</span></td>
        <td>${e.mode==="fatloss"?"Fat loss":e.mode==="weightloss"?"Weight loss":"Weight gain"}</td>
        <td>${e.target ?? ""}</td>
        <td>${e.eaten ?? ""}</td>
        <td>${e.burn ?? ""}</td>
        <td>${def}</td>
        <td>${e.weight ?? ""}</td>
        <td>${e.bodyfat ?? ""}</td>
        <td>${e.protein ?? ""}</td>
        <td>${(e.notes||"").slice(0,42)}</td>
      </tr>
    `;
  }).join("");

  computeKpisAndCharts();
}

function computeKpisAndCharts(){
  const entries = getEntries().filter(e=>e.eaten!=null || e.burn!=null || e.weight!=null).slice().sort((a,b)=>a.date.localeCompare(b.date));
  // --- Profile-driven targets (Phase 2) ---
  const pf = getProfile();
  const mode = getMode();
  const plan = planFor(mode, pf);
  const tdee = Math.round(plan.tdee||0);
  const tgt  = Math.round(plan.target||0);

  const kTargetEl = el('kTarget');
  if(kTargetEl) kTargetEl.textContent = tgt ? String(tgt) : '—';

  const kTdeeEl = el('kTdee');
  if(kTdeeEl) kTdeeEl.textContent = tdee ? String(tdee) : '—';

  // Today deficit/surplus (requires today's entry: eaten + burn)
  const todayIso = new Date().toISOString().slice(0,10);
  const today = entries.find(e=>e.date===todayIso) || null;
  const kTodayEl = el('kToday');
  if(today && ((Number(today.burn)||0) || (Number(today.eaten)||0))){
    const d = Math.round((Number(today.burn)||0) - (Number(today.eaten)||0));
    if(kTodayEl){
      kTodayEl.textContent = (d>=0?'+':'') + d;
      kTodayEl.style.color = d>=0 ? 'var(--good)' : 'var(--bad)';
    }
  }else{
    if(kTodayEl){
      kTodayEl.textContent = '—';
      kTodayEl.style.color = 'var(--text)';
    }
  }


  // avg deficit/surplus 7d
  const defs = last7.map(e => (e.burn!=null && e.eaten!=null) ? (e.burn - e.eaten) : null).filter(v=>v!=null);
  if(defs.length){
    const avg = Math.round(defs.reduce((a,b)=>a+b,0)/defs.length);
    el("kDef").textContent = (avg>=0?avg:("+"+Math.abs(avg))) + " kcal";
    el("kDefS").textContent = avg>=0 ? "Avg daily deficit" : "Avg daily surplus";
  }else{
    el("kDef").textContent = "—"; el("kDefS").textContent = "Per day";
  }

  // weight trend 7d
  const wts = last7.map(e=>toNum(e.weight)).filter(v=>v!=null);
  if(wts.length>=2){
    const ch = Math.round((wts[wts.length-1]-wts[0])*10)/10;
    el("kWt").textContent = (ch>=0?"+":"") + ch + " kg";
  }else el("kWt").textContent = "—";

  // adherence 7d
  const ad = last7.filter(e=>e.target!=null && e.eaten!=null && Math.abs(e.eaten-e.target)<=100).length;
  el("kAdh").textContent = last7.length ? Math.round(100*ad/last7.length) + "%" : "—";

  // charts
  drawLine(el("cWeight"), last14.map(e=>toNum(e.weight)).filter(v=>v!=null), "weight");
  drawLine(el("cDef"), last14.map(e=> (e.burn!=null && e.eaten!=null) ? (e.burn-e.eaten) : null).filter(v=>v!=null), "def");
  // pie
  const last = entries[entries.length-1];
  if(last){
    drawPie(el("cPie"), [
      {label:"Carbs", v: toNum(last.carbs)||0},
      {label:"Protein", v: toNum(last.protein)||0},
      {label:"Fat", v: toNum(last.fat)||0},
    ]);
  }else{
    drawPie(el("cPie"), [{label:"Carbs",v:0},{label:"Protein",v:0},{label:"Fat",v:0}]);
  }
}

function drawAxes(ctx,w,h){
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="rgba(255,255,255,.05)";
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle="rgba(255,255,255,.08)";
  ctx.lineWidth=1;
  for(let i=1;i<5;i++){
    const y = (h*i)/5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }
}

function drawLine(canvas, data, kind){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  drawAxes(ctx,w,h);
  if(!data || data.length<2){
    ctx.fillStyle="rgba(154,167,189,.9)";
    ctx.font="12px system-ui";
    ctx.fillText("No data yet", 14, 24);
    return;
  }
  const min = Math.min(...data), max = Math.max(...data);
  const span = (max-min) || 1;
  const pad = 16;
  ctx.strokeStyle = "rgba(74,163,255,.95)";
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad + (i/(data.length-1))*(w-2*pad);
    const y = h-pad - ((v-min)/span)*(h-2*pad);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // baseline for deficit chart
  if(kind==="def"){
    const y0 = h-pad - ((0-min)/span)*(h-2*pad);
    ctx.strokeStyle="rgba(255,255,255,.14)";
    ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad,y0); ctx.lineTo(w-pad,y0); ctx.stroke();
  }
}

function drawPie(canvas, parts){
  const ctx = canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="rgba(255,255,255,.05)";
  ctx.fillRect(0,0,w,h);
  const total = parts.reduce((a,p)=>a+p.v,0) || 1;
  const cx=w*0.28, cy=h*0.52, r=Math.min(w,h)*0.34;

  const cols = ["rgba(74,163,255,.9)","rgba(42,211,125,.9)","rgba(255,204,102,.9)"];
  let a0 = -Math.PI/2;
  parts.forEach((p,i)=>{
    const a1 = a0 + (p.v/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1);
    ctx.closePath();
    ctx.fillStyle=cols[i%cols.length];
    ctx.fill();
    a0=a1;
  });

  // legend
  ctx.fillStyle="rgba(232,237,246,.95)";
  ctx.font="12px system-ui";
  parts.forEach((p,i)=>{
    const y = 28 + i*18;
    ctx.fillStyle=cols[i%cols.length];
    ctx.fillRect(w*0.62, y-10, 10, 10);
    ctx.fillStyle="rgba(232,237,246,.95)";
    ctx.fillText(`${p.label}: ${Math.round(p.v)}g`, w*0.62 + 16, y-1);
  });
}

/* ===== Day Modal ===== */
let activeDate = null;
function openDay(date){
  activeDate = date;
  const ui = getUI();
  const p = getProfile();
  const e = getEntry(date);
  const d = new Date(date);

  el("dayTitle").textContent = `Edit: ${date} (${d.toLocaleDateString(undefined,{weekday:"long"})})`;

  el("dMode").value = e?.mode || ui.mode;
  el("dTrain").value = e?.training || "rest";

  const defTarget = calcDayDefaultTarget(el("dMode").value, el("dTrain").value, p);
  el("dTarget").value = (e?.target ?? defTarget);
  el("dEaten").value  = (e?.eaten ?? "");
  el("dBurn").value   = (e?.burn ?? "");
  el("dWt").value     = (e?.weight ?? "");
  el("dBf").value     = (e?.bodyfat ?? "");
  el("dP").value      = (e?.protein ?? "");
  el("dC").value      = (e?.carbs ?? "");
  el("dF").value      = (e?.fat ?? "");
  el("dNotes").value  = (e?.notes ?? "");

  computeDayDef();
  el("mDay").classList.add("on");
}
function closeDay(){ el("mDay").classList.remove("on"); activeDate=null; }

function computeDayDef(){
  const burn = toNum(el("dBurn").value);
  const eaten = toNum(el("dEaten").value);
  if(burn!=null && eaten!=null){
    const v = Math.round(burn - eaten);
    el("dDef").value = v>=0 ? `${v} deficit` : `${Math.abs(v)} surplus`;
  }else{
    el("dDef").value = "";
  }
}

["dBurn","dEaten"].forEach(id=>el(id).addEventListener("input", computeDayDef));
["dMode","dTrain"].forEach(id=>el(id).addEventListener("change", ()=>{
  const p = getProfile();
  const defTarget = calcDayDefaultTarget(el("dMode").value, el("dTrain").value, p);
  if(!el("dTarget").value) el("dTarget").value = defTarget;
}));

el("btnSaveDay").addEventListener("click", ()=>{
  if(!activeDate) return;
  const e0 = getEntry(activeDate) || {date:activeDate};

  const e = {
    ...e0,
    date: activeDate,
    mode: el("dMode").value,
    training: el("dTrain").value,
    target: toNum(el("dTarget").value),
    eaten: toNum(el("dEaten").value),
    burn: toNum(el("dBurn").value),
    weight: toNum(el("dWt").value),
    bodyfat: toNum(el("dBf").value),
    protein: toNum(el("dP").value),
    carbs: toNum(el("dC").value),
    fat: toNum(el("dF").value),
    notes: (el("dNotes").value||"").trim(),
    updatedAt: new Date().toISOString()
  };

  // If user never entered profile weight, keep it updated from last entry
  const prof = getProfile();
  if(prof.weightKg==null && e.weight!=null){
    prof.weightKg = e.weight;
    saveJSON(LS_PROFILE, prof);
  }

  upsertEntry(e);
  closeDay();
  render();
});
el("btnCloseDay").addEventListener("click", closeDay);
el("mDay").addEventListener("click", (ev)=>{ if(ev.target.id==="mDay") closeDay(); });

/* ===== Profile Modal ===== */
function openProfile(){
  const p = getProfile();
  el("pSex").value = p.sex || "male";
  el("pAge").value = p.age ?? "";
  el("pH").value   = p.heightCm ?? "";
  el("pW").value   = p.weightKg ?? "";
  el("pBf").value  = p.bodyFatPct ?? "";
  el("pAct").value = String(p.activity ?? 1.55);
  el("pGW").value  = p.goalWeightKg ?? "";
  el("pGBf").value = p.goalBodyFatPct ?? "";
  updateProfilePreview();
  el("mProfile").classList.add("on");
}
function closeProfile(){ el("mProfile").classList.remove("on"); }

function readProfileFromUI(){
  return {
    sex: el("pSex").value,
    age: toNum(el("pAge").value),
    heightCm: toNum(el("pH").value),
    weightKg: toNum(el("pW").value),
    bodyFatPct: toNum(el("pBf").value),
    activity: toNum(el("pAct").value) ?? 1.55,
    goalWeightKg: toNum(el("pGW").value),
    goalBodyFatPct: toNum(el("pGBf").value),
  };
}
function updateProfilePreview(){
  const p = readProfileFromUI();
  const b = bmrMifflin(p);
  const T = tdee(p);
  const pl = planFor(getUI().mode, p);
  const goalW = p.goalWeightKg!=null ? `Goal weight: ${p.goalWeightKg} kg<br/>` : "";
  const goalBf = p.goalBodyFatPct!=null ? `Goal body fat: ${p.goalBodyFatPct}%<br/>` : "";
  el("profilePreview").innerHTML = `
    <b>BMR:</b> ${b ?? "—"} kcal<br/>
    <b>TDEE:</b> ${T ?? "—"} kcal<br/>
    <b>Mode target:</b> ${pl.targetKcal} kcal (${pl.deltaKcal>=0?"+":""}${pl.deltaKcal} vs TDEE)<br/>
    <b>Protein:</b> ${pl.proteinG} g/day<br/>
    <b>Weekly rate:</b> ${(pl.weeklyKg>=0?"+":"")}${pl.weeklyKg} kg/week (estimate)<br/>
    ${goalW}${goalBf}
  `.trim();
}
["pSex","pAge","pH","pW","pBf","pAct","pGW","pGBf"].forEach(id=>el(id).addEventListener("input", updateProfilePreview));
["pAct","pSex"].forEach(id=>el(id).addEventListener("change", updateProfilePreview));

el("btnSaveProfile").addEventListener("click", ()=>{
  const p = readProfileFromUI();
  saveJSON(LS_PROFILE, p);
  closeProfile();
  render();
});
el("btnCloseProfile").addEventListener("click", closeProfile);
el("mProfile").addEventListener("click", (ev)=>{ if(ev.target.id==="mProfile") closeProfile(); });

/* ===== Export / Import ===== */
function download(name, content, type){
  const blob = new Blob([content], {type:type||"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
}

el("btnExportJSON").addEventListener("click", ()=>{
  const payload = { profile:getProfile(), entries:getEntries(), exportedAt:new Date().toISOString() };
  download(`bodycomp_export_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload,null,2), "application/json");
});
el("btnExportCSV").addEventListener("click", ()=>{
  const rows = [];
  const cols = ["date","mode","training","target","eaten","burn","deficit","weight","bodyfat","protein","carbs","fat","notes","updatedAt"];
  rows.push(cols.join(","));
  getEntries().forEach(e=>{
    const def = (e.burn!=null && e.eaten!=null) ? (e.burn-e.eaten) : "";
    const vals = cols.map(k=>{
      let v = (k==="deficit") ? def : (e[k] ?? "");
      v = String(v).replace(/"/g,'""');
      return `"${v}"`;
    });
    rows.push(vals.join(","));
  });
  download(`bodycomp_export_${new Date().toISOString().slice(0,10)}.csv`, rows.join("
"), "text/csv");
});

el("fileImport").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const txt = await f.text();
  if(f.name.toLowerCase().endsWith(".json")){
    try{
      const obj = JSON.parse(txt);
      if(obj.profile) saveJSON(LS_PROFILE, obj.profile);
      if(Array.isArray(obj.entries)) setEntries(obj.entries);
      render();
    }catch(_){ alert("Invalid JSON"); }
  }else if(f.name.toLowerCase().endsWith(".csv")){
    // Simple CSV import matching our export (quoted)
    const lines = txt.split(/
?
/).filter(Boolean);
    if(lines.length<2){ alert("CSV empty"); return; }
    const head = lines.shift().split(",").map(s=>s.replace(/^"|"$/g,""));
    const out = [];
    lines.forEach(line=>{
      const parts = [];
      let cur="", inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='\"'){
          if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; }
          else inQ=!inQ;
        }else if(ch===',' && !inQ){ parts.push(cur); cur=""; }
        else cur+=ch;
      }
      parts.push(cur);
      const o = {};
      head.forEach((h,i)=>{ o[h]=parts[i] ?? ""; });
      const e = {
        date:o.date,
        mode:o.mode||"fatloss",
        training:o.training||"rest",
        target: toNum(o.target),
        eaten: toNum(o.eaten),
        burn: toNum(o.burn),
        weight: toNum(o.weight),
        bodyfat: toNum(o.bodyfat),
        protein: toNum(o.protein),
        carbs: toNum(o.carbs),
        fat: toNum(o.fat),
        notes: (o.notes||"").replace(/^"|"$/g,""),
        updatedAt: o.updatedAt||new Date().toISOString()
      };
      if(e.date) out.push(e);
    });
    setEntries(out);
    render();
  }else{
    alert("Unsupported file type");
  }
  ev.target.value="";
});

/* ===== Month Nav ===== */
el("btnPrev").addEventListener("click", ()=>{
  const ui=getUI();
  const d=new Date(ui.y, ui.m-1, 1);
  ui.y=d.getFullYear(); ui.m=d.getMonth();
  setUI(ui); render();
});
el("btnNext").addEventListener("click", ()=>{
  const ui=getUI();
  const d=new Date(ui.y, ui.m+1, 1);
  ui.y=d.getFullYear(); ui.m=d.getMonth();
  setUI(ui); render();
});
el("btnToday").addEventListener("click", ()=>{
  const ui=getUI();
  const d=new Date();
  ui.y=d.getFullYear(); ui.m=d.getMonth();
  setUI(ui); render();
});
el("btnProfile").addEventListener("click", openProfile);

document.addEventListener("click", (ev)=>{
  const day = ev.target.closest(".day");
  if(day && day.dataset.date) openDay(day.dataset.date);
});

document.querySelectorAll("#modePills .pill").forEach(pill=>{
  pill.addEventListener("click", ()=>{
    const ui=getUI();
    ui.mode = pill.dataset.mode;
    setUI(ui);
    render();
  });
});

/* ===== Monthly snapshot ===== */
el("btnSnapshot").addEventListener("click", ()=>{
  const ui=getUI();
  const ym = `${ui.y}-${pad2(ui.m+1)}`;
  const entries = getEntries().filter(e=>e.date.startsWith(ym));
  const payload = {month: ym, profile:getProfile(), mode: ui.mode, entries, exportedAt:new Date().toISOString()};
  download(`bodycomp_snapshot_${ym}.json`, JSON.stringify(payload,null,2), "application/json");
});

/* ===== Reset ===== */
el("btnReset").addEventListener("click", ()=>{
  if(!confirm("Delete all local data for this tracker?")) return;
  localStorage.removeItem(LS_PROFILE);
  localStorage.removeItem(LS_ENTRIES);
  localStorage.removeItem(LS_UI);
  render();
});

/* ===== Init ===== */
(function init(){
  // Seed UI if missing
  const ui = getUI();
  setUI(ui);
  // Show profile preview once
  updateProfilePreview();
  render();
})();


/* =========================
   Phase 3 — Drive autosync + versioned monthly backups
   ========================= */
const DRIVE_CFG = {
  clientId: "41189729388-rksho3qtsot9qv7h2g4c0s8q81ghub6u.apps.googleusercontent.com",
  apiKey: "AIzaSyD3SRe0koUE0MdEE0JWllD5V8L1LkoP7iGs",
  scopes: "https://www.googleapis.com/auth/drive.file",
  rootFolderName: "BodyComp_Control",
  latestPrefix: "BodyComp_",
};

function toast(msg){
  try{
    let t=document.getElementById('toast');
    if(!t){
      t=document.createElement('div');
      t.id='toast';
      t.style.position='fixed';
      t.style.left='50%';
      t.style.bottom='18px';
      t.style.transform='translateX(-50%)';
      t.style.padding='10px 12px';
      t.style.background='rgba(0,0,0,.75)';
      t.style.color='#fff';
      t.style.border='1px solid rgba(255,255,255,.18)';
      t.style.borderRadius='12px';
      t.style.fontSize='12px';
      t.style.zIndex='99999';
      t.style.maxWidth='90vw';
      t.style.whiteSpace='nowrap';
      t.style.overflow='hidden';
      t.style.textOverflow='ellipsis';
      t.style.opacity='0';
      t.style.transition='opacity .18s ease';
      document.body.appendChild(t);
    }
    t.textContent=msg;
    requestAnimationFrame(()=>{t.style.opacity='1';});
    clearTimeout(window.__toastTimer);
    window.__toastTimer=setTimeout(()=>{t.style.opacity='0';},1500);
  }catch(e){ console.log(msg); }
}

const driveState = {
  enabled: false,
  token: null,
  tokenClient: null,
  gapiReady: false,
  gisReady: false,
  syncing: false,
  rootFolderId: null,
  monthFolderIds: {},     // month -> folderId
  latestFileIds: {},      // month -> fileId
};

function getMonthKeySafe(){
  const ui = getUI();
  return (ui && ui.month) ? ui.month : new Date().toISOString().slice(0,7);
}

function setUIWithDrive(patch){
  const ui = getUI();
  const merged = Object.assign({}, ui, patch);
  setUI(merged);
  return merged;
}

function updateDriveBtn(){
  const btn = document.getElementById("btnDrive");
  if(!btn) return;
  const ui = getUI();
  const on = !!(ui && ui.driveEnabled);
  btn.textContent = on ? "Drive: On" : "Drive: Off";
  btn.classList.toggle("primary", on);
}

function driveSetEnabled(on){
  setUIWithDrive({ driveEnabled: !!on });
  updateDriveBtn();
}

function driveLibsReady(){
  // gapi and google accounts scripts load async; detect readiness.
  const gapiOk = typeof window.gapi !== "undefined";
  const gisOk  = window.google && window.google.accounts && window.google.accounts.oauth2;
  return { gapiOk, gisOk };
}

async function driveInit(){
  const { gapiOk, gisOk } = driveLibsReady();
  if(!gapiOk || !gisOk) throw new Error("Drive libraries not loaded yet. Refresh and try again.");
  if(!driveState.gisReady){
    driveState.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: DRIVE_CFG.clientId,
      scope: DRIVE_CFG.scopes,
      callback: (resp) => { /* set by requestToken */ }
    });
    driveState.gisReady = true;
  }
  if(!driveState.gapiReady){
    await new Promise((resolve, reject)=>{
      gapi.load("client", { callback: resolve, onerror: reject });
    });
    await gapi.client.init({
      apiKey: DRIVE_CFG.apiKey,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
    });
    driveState.gapiReady = true;
  }
}

async function driveRequestToken(){
  await driveInit();
  return new Promise((resolve, reject)=>{
    driveState.tokenClient.callback = (resp)=>{
      if(resp && resp.access_token){
        driveState.token = resp.access_token;
        gapi.client.setToken({ access_token: resp.access_token });
        resolve(resp.access_token);
      } else {
        reject(new Error("No access token returned"));
      }
    };
    driveState.tokenClient.requestAccessToken({ prompt: "" });
  });
}

function driveDisconnect(){
  driveState.token = null;
  driveState.rootFolderId = null;
  driveState.monthFolderIds = {};
  driveState.latestFileIds = {};
  driveSetEnabled(false);
}

async function driveEnsureFolder(name, parentId){
  const q = [
    "mimeType='application/vnd.google-apps.folder'",
    "trashed=false",
    `name='${name.replace(/'/g,"\\'")}'`,
    parentId ? `'${parentId}' in parents` : null
  ].filter(Boolean).join(" and ");
  const res = await gapi.client.drive.files.list({
    q,
    fields: "files(id,name)",
    pageSize: 10
  });
  const files = (res.result && res.result.files) || [];
  if(files.length) return files[0].id;
  const create = await gapi.client.drive.files.create({
    resource: {
      name,
      mimeType: "application/vnd.google-apps.folder",
      parents: parentId ? [parentId] : undefined
    },
    fields: "id"
  });
  return create.result.id;
}

async function driveEnsureRoot(){
  if(driveState.rootFolderId) return driveState.rootFolderId;
  const id = await driveEnsureFolder(DRIVE_CFG.rootFolderName, null);
  driveState.rootFolderId = id;
  return id;
}

async function driveEnsureMonthFolder(monthKey){
  if(driveState.monthFolderIds[monthKey]) return driveState.monthFolderIds[monthKey];
  const rootId = await driveEnsureRoot();
  const id = await driveEnsureFolder(monthKey, rootId);
  driveState.monthFolderIds[monthKey] = id;
  return id;
}

async function driveFindFileIdByName(name, parentId){
  const q = [
    "trashed=false",
    `name='${name.replace(/'/g,"\\'")}'`,
    parentId ? `'${parentId}' in parents` : null
  ].filter(Boolean).join(" and ");
  const res = await gapi.client.drive.files.list({
    q,
    fields: "files(id,name,modifiedTime)",
    pageSize: 5,
    orderBy: "modifiedTime desc"
  });
  const files = (res.result && res.result.files) || [];
  return files.length ? files[0].id : null;
}

async function driveUploadJson({ parentId, filename, json, fileId=null }){
  const boundary = "-------314159265358979323846";
  const delimiter = "\r\n--" + boundary + "\r\n";
  const close_delim = "\r\n--" + boundary + "--";
  const metadata = {
    name: filename,
    mimeType: "application/json",
    parents: parentId ? [parentId] : undefined
  };
  const body =
    delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(metadata) +
    delimiter +
    "Content-Type: application/json\r\n\r\n" +
    JSON.stringify(json) +
    close_delim;

  if(fileId){
    const res = await gapi.client.request({
      path: "/upload/drive/v3/files/" + encodeURIComponent(fileId),
      method: "PATCH",
      params: { uploadType: "multipart" },
      headers: { "Content-Type": "multipart/related; boundary=" + boundary },
      body
    });
    return res.result.id;
  } else {
    const res = await gapi.client.request({
      path: "/upload/drive/v3/files",
      method: "POST",
      params: { uploadType: "multipart" },
      headers: { "Content-Type": "multipart/related; boundary=" + boundary },
      body
    });
    return res.result.id;
  }
}

function buildDrivePayload(){
  const profile = loadProfile();
  const ui = getUI();
  const entries = loadEntries(); // full history
  const monthKey = getMonthKeySafe();
  const monthEntries = entries.filter(e => (e.date||"").slice(0,7) === monthKey);
  return {
    meta: {
      app: "BodyComp_Control",
      version: "phase3",
      exportedAt: new Date().toISOString(),
      month: monthKey
    },
    profile,
    ui,
    entries: monthEntries
  };
}

async function driveSyncNow(reason="manual"){
  if(driveState.syncing) return;
  driveState.syncing = true;
  try{
    await driveRequestToken();
    const monthKey = getMonthKeySafe();
    const monthFolderId = await driveEnsureMonthFolder(monthKey);

    const payload = buildDrivePayload();
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    const versionedName = `${DRIVE_CFG.latestPrefix}${monthKey}_${ts}.json`;
    const latestName = `${DRIVE_CFG.latestPrefix}${monthKey}_latest.json`;

    // Always create a versioned backup
    await driveUploadJson({ parentId: monthFolderId, filename: versionedName, json: payload });

    // Update latest
    let latestId = driveState.latestFileIds[monthKey] || await driveFindFileIdByName(latestName, monthFolderId);
    latestId = await driveUploadJson({ parentId: monthFolderId, filename: latestName, json: payload, fileId: latestId });
    driveState.latestFileIds[monthKey] = latestId;

    // Mark enabled after first successful sync
    driveSetEnabled(true);
    toast(`Drive sync OK (${reason})`);
  }catch(err){
    console.error(err);
    toast("Drive sync failed. Check Console.");
    driveSetEnabled(false);
  }finally{
    driveState.syncing = false;
    updateDriveBtn();
  }
}

async function onDriveClick(){
  const ui = getUI();
  const on = !!(ui && ui.driveEnabled);
  if(on){
    driveDisconnect();
    toast("Drive sync off");
    return;
  }
  await driveSyncNow("connect");
}

function queueDriveAutosync(){
  const ui = getUI();
  if(!(ui && ui.driveEnabled)) return;
  // debounce so we don't spam Drive
  window.__driveDebounce && clearTimeout(window.__driveDebounce);
  window.__driveDebounce = setTimeout(()=>{ driveSyncNow("auto"); }, 1200);
}

/* Hook autosync after any save */
const __orig_saveEntries = saveEntries;
saveEntries = function(entries){
  __orig_saveEntries(entries);
  queueDriveAutosync();
};

const __orig_saveProfile = saveProfile;
saveProfile = function(profile){
  __orig_saveProfile(profile);
  queueDriveAutosync();
};

const __orig_setUI = setUI;
setUI = function(ui){
  __orig_setUI(ui);
  // update button if month changes
  updateDriveBtn();
};

document.addEventListener("DOMContentLoaded", ()=>{
  updateDriveBtn();
  const btn = document.getElementById("btnDrive");
  if(btn) btn.addEventListener("click", onDriveClick);
});

</script>
</body>
</html>
